---
title: "React Router V6 - Loading Data"
excerpt: "ä¸Šä¸€ç¯‡ä»‹ç´¹äº† React Router V6 çš„åŸºæœ¬æ¶æ§‹ï¼ŒåŒ…å«å°é ã€å‹•æ…‹è·¯ç”±èˆ‡å·¢ç‹€è·¯ç”±ï¼Œæœ¬æ–‡å‰‡æœƒä»‹ç´¹ V6 å…¨æ–°çš„é‡è¦åŠŸèƒ½ Loaderï¼Œä¾†é«”é©—ä¸€ä¸‹å®ƒçš„å¨åŠ›å§ï¼"
tags: ["React", "React Router"]
date: "2023-03-31"
---

## What's New in React Router v6

ã€Œé€²å…¥ç•«é¢å¾Œï¼Œéœ€è¦ Call API å–å¾—åˆå§‹è³‡æ–™ï¼ã€

é€™å€‹éœ€æ±‚æ‡‰è©²ä¸é™Œç”Ÿå§ï¼Ÿè¨±å¤šé é¢éƒ½æœ‰é€™å€‹å‹•ä½œï¼Œä¾‹å¦‚ï¼šä¸€é€²åˆ°å•†å“é ï¼Œå…ˆå–å¾—å•†å“è³‡æ–™ã€‚

é€™éº¼åšä¸¦æ²’éŒ¯ï¼Œä½†æ˜¯é€™åœ¨ä½¿ç”¨è€…é«”é©—ä¸Šè¼ƒå·®ï¼Œå› çˆ²ç•¶ User é€²å…¥é é¢æ™‚ï¼Œç•«é¢æˆ–è¨±é‚„æ²’æ¸²æŸ“å®Œæˆã€‚

é‡å°é€™ä¸€é»ï¼ŒReact Router V6 æä¾›äº† `loader` é€™é …åŠŸèƒ½ï¼Œè®“è³‡æ–™å¯ä»¥é€éè·¯ç”±ç³»çµ±å…ˆè¡Œè™•ç†ï¼Œåœ¨æ¸²æŸ“å‰å…ˆ Loading Dataã€‚

## ä½¿ç”¨ loader èˆ‡ useLoaderData ç²å–è³‡æ–™

å¯ä»¥ç‚ºè·¯ç”±å®šç¾© `loader` åƒæ•¸ï¼Œå€¼ç‚ºä¸€å€‹å‡½å¼ï¼Œä¸¦ä¸”é æœŸæœƒ Return è³‡æ–™ï¼Œè®“æˆ‘å€‘åœ¨å…ƒä»¶ä¸­å–ç”¨ã€‚

æˆ‘å€‘åœ¨ `loader` ä½¿ç”¨ Async/Await å»å‘¼å« APIï¼Œé›–ç„¶é€™æœƒå›å‚³ä¸€å€‹ Promiseï¼Œä½†æ˜¯ React Router æœƒç¢ºä¿ API è³‡æ–™å·²ç¶“å›å‚³ï¼Œè®“æˆ‘å€‘èƒ½å¤ åœ¨å…ƒä»¶ä¸­å–å¾— `resData.events` çš„è³‡æ–™ã€‚

```jsx
// App.js

const router = createBrowserRouter([
  {
    path: "/",
    element: <RootLayout />,
    children: [
      {
        path: "events",
        element: <EventRootLayout />,
        children: [
          {
            index: true,
            element: <Events />,
            loader: async () => {
              const response = await fetch("http://localhost:8080/events");
              if (!response.ok) {
                // Handle Error...
              } else {
                const resData = await response.json();
                return resData.events;
              }
            },
          },
        ],
      },
    ],
  },
]);
```

ç„¶å¾Œæˆ‘å€‘å°±å¯ä»¥å¾ˆè¼•é¬†è‡ªåœ¨åœ°ï¼Œç›´æ¥åˆ°å…ƒä»¶è£¡é¢ï¼Œé€é `useLoaderData` å–å¾— Events è³‡æ–™ã€‚

```jsx
// Events.js

const EventsPage = () => {
  const events = useLoaderData();

  return <EventsList events={events} />;
};

export default EventsPage;
```

å—¯ â‹¯â‹¯ ä½†æ˜¯å¦‚æœæˆ‘å€‘åœ¨ `App.js` é€™é¡å®šç¾©è·¯ç”±çš„æª”æ¡ˆå¯«ä¸€å † `loader`ï¼Œé‚£é€™å€‹æª”æ¡ˆä¸å°±æœƒè®Šå¾—è¶…å¤§ä¸€åŒ…å—ï¼Ÿ

æ²’éŒ¯å–”ï¼Œæ‰€ä»¥å»ºè­°çš„åšæ³•é‚„æ˜¯å°‡ Loader å¯«åœ¨ Page Component è£¡é¢å† `export` åˆ°è·¯ç”±è£¡é¢å®šç¾©ã€‚

```jsx
// Events.js

// ...
export default EventsPage;

export const loader = async () => {
  const response = await fetch("http://localhost:8080/events");
  if (!response.ok) {
    // Handle Error...
  } else {
    const resData = await response.json();
    return resData.events;
  }
};
```

åœ¨è·¯ç”±ä¸­ `import` å®šç¾©çš„ `loader` æ™‚ï¼Œå¯ä»¥ç”¨ alias å®šç¾©ä¸åŒ Page çš„ `loader` åç¨±ï¼Œä¾‹å¦‚ `Events` å°±æ˜¯ `eventsLoader`ã€‚

```jsx
// App.js

import Events, { loader as eventsLoader } from "./pages/Events";

const router = createBrowserRouter([
  {
    path: "/",
    element: <RootLayout />,
    children: [
      ,
      {
        path: "events",
        element: <EventRootLayout />,
        children: [
          {
            index: true,
            element: <Events />,
            loader: eventsLoader,
          },
        ],
      },
    ],
  },
]);
```

## Behind The Scenes: When Are loader() Functions Executed

å¦‚æœä½ çš„ API å›å‚³æ™‚é–“è¼ƒé•·ï¼Œæˆ–æ˜¯åˆ»æ„è®“ API å»¶é²å›å‚³ï¼Œå°±å¯ä»¥ç™¼ç¾ Router çš„è·³è½‰ï¼Œå…¶å¯¦æ˜¯ç­‰åˆ° `loader` å–å¾—è³‡æ–™å¾Œæ‰åŸ·è¡Œã€‚

é€™å€‹æ©Ÿåˆ¶çš„å„ªé»æ˜¯èƒ½å¤ ç¢ºä¿ä½ å·²ç¶“å–å¾—è³‡æ–™ï¼Œæ¥è‘—æ‰å»æ¸²æŸ“ç•«é¢ã€‚ä½†ç¼ºé»æ˜¯ï¼Œä½¿ç”¨è€…åœ¨åˆ‡æ›è·¯ç”±æ™‚å¯èƒ½æœƒå‡ºç¾å»¶é²ï¼Œæä¸å¥½é‚„æœƒå› æ­¤ä»¥ç‚ºç¶²é å£æ‰äº†ã€‚

é—œæ–¼é€™å€‹å•é¡Œï¼Œæˆ‘å€‘å¯ä»¥é€é `useNavigation` çš„ `state` å»åˆ¤æ–·è©²è·¯ç”±çš„ç‹€æ…‹ï¼Œä¸¦æ ¹æ“šç‹€æ…‹åŠ ä¸Š Loading æ¨£å¼ã€‚

```jsx
const RootLayout = () => {
  const navigation = useNavigation();

  return (
    <>
      <MainNavigation />
      <main>
        {navigation.state === "loading" && <p>Loading...</p>}
        <Outlet />
      </main>
    </>
  );
};
```

æé†’ä¸€ä¸‹ï¼Œ`loader()` æ˜¯åœ¨ Browser ç’°å¢ƒåŸ·è¡Œï¼Œè€Œéåœ¨ Server åŸ·è¡Œã€‚

å¦å¤–ï¼Œé›–ç„¶æ˜¯åœ¨ Browser åŸ·è¡Œï¼Œä½†æ˜¯ `loader()` è£¡é¢ã€Œä¸èƒ½ã€ä½¿ç”¨åƒæ˜¯ `useState` èˆ‡ `useParams` ç­‰ React Hooksã€‚

## Throw Responses and Catch Errors with useRouteError

åœ¨ä¸Šä¸€ç¯‡ React Router Setup çš„æ–‡ç« è£¡ï¼Œæˆ‘å€‘ä½¿ç”¨ `errorElement` ä¾†æŒ‡å®šç•¶è·¯ç”±å°å‘ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œæ‡‰è©²æ¸²æŸ“çš„é é¢æˆ–å…ƒä»¶ã€‚è€Œé€™å€‹ Error é é¢é™¤äº†ç”¨åœ¨è™•ç†éŒ¯èª¤çš„è·¯ç”±ï¼ŒåŒæ¨£ä¹Ÿèƒ½ç”¨ä¾†è™•ç†éŒ¯èª¤çš„ API å›æ‡‰ã€‚

ç¯„ä¾‹ï¼šé¦–å…ˆï¼Œåœ¨çˆ¶è·¯ç”±ï¼ˆä¹Ÿå°±æ˜¯æœ€å¤–å±¤ï¼‰è¨­ç½®éŒ¯èª¤é é¢ã€‚

```jsx
const router = createBrowserRouter([
  {
    path: "/",
    element: <RootLayout />,
    errorElement: <Error />, // catch any errors
    children: [
      { index: true, element: <Home /> },
      {
        path: "events",
        element: <EventRootLayout />,
        children: [
          {
            index: true,
            element: <Events />,
            loader: eventsLoader,
          },
        ],
      },
    ],
  },
]);
```

> æ ¹æ“šéœ€æ±‚ï¼Œä½ å¯ä»¥åœ¨çˆ¶å­è·¯ç”±å€‹åˆ¥è¨­ç½® `errorElement`ï¼Œä½†å¦‚æœå­è·¯ç”±æ²’æœ‰è¨­ç½®ï¼Œé‚£éº¼å­è·¯ç”±çš„ Error å°±æœƒ Bubble Up è‡³çˆ¶è·¯ç”±ã€‚

æ¥ä¸‹ä¾†æˆ‘å€‘ç”¨ `throw new Response()` çš„æ–¹å¼æ‹‹å‡ºéŒ¯èª¤ï¼Œé€™æ˜¯ä¸€å€‹è¿‘æœŸæ¯”è¼ƒæ¨è–¦çš„åšæ³•ï¼Œå› ç‚ºé€™æ¨£å¯ä»¥è®“å‰ç«¯ä¾ç…§ä¸åŒçš„ `status` é¡¯ç¤ºä¸åŒè³‡è¨Šçµ¦ä½¿ç”¨è€…ã€‚

```jsx
// Events.js

const EventsPage = () => {
  const data = useLoaderData();
  const events = data.events;

  return <EventsList events={events} />;
};

export default EventsPage;

export const loader = async () => {
  const response = await fetch("http://localhost:8080/events");
  if (!response.ok) {
    throw new Response(JSON.stringify({ message: "Could not fetch events" }), {
      status: 500,
    });
  } else {
    return response;
  }
};
```

å®šç¾©å¥½éŒ¯èª¤è¨Šæ¯å¾Œï¼Œæˆ‘å€‘é€é React Router V6 æä¾›çš„ `useRouteError` å»å–å¾—éŒ¯èª¤è¨Šæ¯ã€‚

ç•¶æˆ‘å€‘æ˜¯ Throw Responses çš„æ™‚å€™ï¼Œ`useRouteError` èƒ½é€é `JSON.parse(error.data)` å»å–å¾—å›å‚³è³‡æ–™ï¼Œä»¥åŠé€é `error.status` å–å¾—ä¸åŒçš„ç‹€æ…‹ã€‚

```jsx
// Error.js

const Error = () => {
  const error = useRouteError();

  let title = "Oops!";
  let message = "Sorry, an unexpected error has occurred.";

  // API Error
  if (error.status === 500) {
    message = JSON.parse(error.data).message;
  }

  // Path Error
  if (error.status === 404) {
    title = "Not Found!";
    message = "Could not find resource or page.";
  }

  return (
    <PageContent title={title}>
      <p>{message}</p>
    </PageContent>
  );
};
```

> å¦‚æœä½ æ˜¯å›å‚³ä¸€èˆ¬ç‰©ä»¶ï¼Œåƒæ˜¯ `return {message: "error"}`ï¼Œé‚£éº¼é€™å€‹ `error` å°±æœƒæ˜¯é‚£å€‹ç‰©ä»¶æœ¬èº«äº†ã€‚

## The Utility Function: json()

æˆ‘å¿…é ˆæ‰¿èªï¼Œæˆ‘è‡ªå·±çœ‹åˆ°å›å‚³ Responses çš„ä½œæ³•æ™‚è¦ºå¾—å¾ˆéº»ç…©ï¼Œé›–ç„¶éµå¾ªé€™å€‹æ–¹å¼å¯ä»¥å®šç¾©ä¸åŒçš„éŒ¯èª¤ç‹€æ…‹ï¼Œä»¥çµ¦äºˆæ›´å¥½çš„ä½¿ç”¨è€…é«”é©—ï¼Œä½†æ˜¯é€™è®“ Code è®Šå¾—è¤‡é›œè¨±å¤šå•Šï¼

é‚„å¥½ï¼æˆ–è¨±æ˜¯å› ç‚º React Router V6 åœ˜éšŠä¹Ÿè¦ºå¾—å¾ˆç¹ç‘£ï¼Œæ‰€ä»¥ä»–å€‘æº–å‚™äº†ä¸€å€‹ Utility Function å«åš `json()` è®“æˆ‘å€‘ä½¿ç”¨ ğŸ¥º

ç¸½ä¹‹ï¼Œä½ å‰›å‰›ä¸Šé¢é‚£ä¸€å¤§ä¸²ï¼Œå¯ä»¥è®Šæˆä»¥ä¸‹é€™æ¨£ã€‚

```jsx
// Events.js

export const loader = async () => {
  const response = await fetch("http://localhost:8080/events22");
  if (!response.ok) {
    // throw new Response(JSON.stringify({ message: "Could not fetch events" }), {
    //   status: 500,
    // });
    throw json({ message: "Could not fetch events" }, { status: 500 });
  } else {
    return response;
  }
};
```

èˆ‡æ­¤åŒæ™‚ï¼Œä½ ç”¨ `useRouteError` å–å¾— `error.data` å¾Œä¹Ÿä¸éœ€è¦å†åš `JSON.parse()` äº†ã€‚

```jsx
// Error.js

if (error.status === 500) {
  // message = JSON.parse(error.data).message;
  message = error.data.message;
}
```

å¯å–œå¯è³€ ğŸ»

## ä½¿ç”¨ loader() çš„åƒæ•¸

`loader` è‡ªå¸¶å…©å€‹åƒæ•¸ `request` èˆ‡ `params`ï¼š

- `request` ç‚ºä¸€å€‹ Request çš„ Standard Web Objectï¼Œå¯ä»¥å­˜å–åƒæ˜¯ URL ç­‰è³‡è¨Š
- `params` ç‚º Route Parametersï¼Œä¹Ÿå°±æ˜¯å‹•æ…‹è·¯ç”±å†’è™Ÿå¾Œé¢çš„ Segments

ä¾‹å¦‚ï¼šä½æ–¼ `/events/:eventId` é é¢æ™‚ï¼Œ`loader()` å¯ä»¥é€é `params.eventId` å–å¾—å‹•æ…‹è·¯ç”±çš„ç‰‡æ®µï¼Œé€²è€Œå–å¾—æ´»å‹•çš„è©³ç´°è³‡æ–™ã€‚

```jsx
// EventDetail.js

export const loader = async ({ request, params }) => {
  const id = params.eventId;
  const response = await fetch(`http://localhost:8080/events/${id}`);
  if (!response.ok) {
    throw json(
      { message: "Could not fetch details for the selected event" },
      {
        status: 500,
      },
    );
  } else {
    return response;
  }
};
```

## é€šé useRouteLoaderData() åœ¨å­è·¯ç”±ä¹‹é–“åˆ†äº« loader

å¦‚æœç•¶å‰çš„è·¯ç”±éœ€è¦çš„ Loader å·²ç¶“åœ¨å…¶ä»–è·¯ç”±å®šç¾©éï¼Œæˆ‘å€‘å°±ä¸ç”¨é‡è¤‡æ’°å¯«ä¸€æ¬¡ï¼Œå¯ä»¥ç¶“ç”± useRouteLoaderData Hook ä¾†å­˜å–é€™ä»½ Loaderã€‚

è·¯ç”±ä¹‹é–“æƒ³è¦åˆ†äº«åŒä¸€ä»½ Loader æ™‚å¿…é ˆæ˜¯å­è·¯ç”±ï¼Œæˆ‘å€‘å¯ä»¥æ–°å¢ä¸€å±¤çˆ¶è·¯ç”±ï¼Œä¸çµ¦äºˆ `element` è€Œæ˜¯åªå®šç¾© `loader`ï¼ŒåŒæ™‚è³¦äºˆä¸€å€‹ `id`ï¼Œé€™æ¨£è£¡é¢çš„å­è·¯ç”±å°±èƒ½é€é `useRouteLoaderData(id)` å–å¾—è³‡æ–™ã€‚

ç¯„ä¾‹ï¼šç•¶ EditEvent é é¢ä¹Ÿéœ€è¦ä½¿ç”¨ EventDetail é é¢çš„ Loader æ™‚ï¼Œé¦–å…ˆé‡æ–°é…ç½®è·¯ç”±ï¼Œå°‡å®ƒå€‘æ”¾åœ¨åŒä¸€å€‹çˆ¶è·¯ç”±åº•ä¸‹ã€‚

```jsx
// App.js

const router = createBrowserRouter([
  {
    path: "/",
    children: [
      {
        path: "events",
        element: <EventRootLayout />,
        children: [
          {
            path: ":eventId",
            id: "event-detail", // è¨˜å¾—åŠ ä¸Š ID
            loader: eventDetailLoader, // å…±ç”¨çš„ Loader
            children: [
              {
                index: true,
                element: <EventDetail />,
              },
              { path: "edit", element: <EditEvent /> },
            ],
          },
        ],
      },
    ],
  },
]);
```

åœ¨ EventDetail é é¢ä¸­ï¼ŒåŸæœ¬çš„ `useLoaderData` æ”¹ç‚ºä½¿ç”¨ `useRouteLoaderData`ã€‚è€Œ EditEvent é é¢ä¹Ÿä½¿ç”¨ `useRouteLoaderData("event-detail")` å–å¾— Loader è³‡æ–™ã€‚

```jsx
// EventDetail.js
const EventDetail = () => {
  const data = useRouteLoaderData("event-detail");

  return <EventItem event={data.event} />;
};

// EditEvent.js
const EditEvent = () => {
  const data = useRouteLoaderData("event-detail");

  return (
    <>
      <h1>EditEvent</h1>
      <EventForm event={data.event} />
    </>
  );
};
```

> æ³¨æ„ï¼š`useRouteLoaderData` å¿…é ˆæ¥æ”¶ Routes ID é€™ä¸€å€‹åƒæ•¸æ‰èƒ½é‹ä½œå–”ã€‚
